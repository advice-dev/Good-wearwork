<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GOODWEAR Marketplace</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
*{box-sizing:border-box;font-family:Poppins,Arial,sans-serif}
body{margin:0;background:linear-gradient(135deg,#fffaf5,#fff0e6);color:#333;padding-bottom:90px}
h1,h2,h3{color:#ff6600}.page{display:none}.active{display:block}
.container{max-width:900px;margin:auto;background:#fff;border-radius:20px;padding:22px;box-shadow:0 10px 30px rgba(255,102,0,.15);border:1px solid #ffe0cc}
input,textarea,button{width:100%;padding:13px;margin:10px 0;border-radius:12px;border:2px solid #ffccb3;font-size:15px;background:#fff;color:#333}
input::placeholder,textarea::placeholder{color:#999}
button{background:linear-gradient(135deg,#ff6600,#ff8c33);color:#fff;border:none;font-weight:700;box-shadow:0 4px 12px rgba(255,102,0,.3)}
button:hover{opacity:.9;transform:translateY(-1px)}
.nav{position:fixed;bottom:0;left:0;width:100%;background:#fff;border-top:2px solid #ffccb3;display:flex;justify-content:space-around;padding:12px 0}
.nav button{background:none;color:#ff6600;font-size:22px;width:auto;box-shadow:none}
.card{border:1px solid #ffe0cc;border-radius:18px;padding:15px;margin:16px 0;background:#fffaf8}
.card img{width:100%;height:230px;object-fit:cover;border-radius:14px}
.price{font-size:22px;font-weight:800;color:#ff6600}
.badge{background:#ff6600;color:#fff;padding:8px 16px;border-radius:30px;display:inline-block;margin-bottom:12px;font-weight:700}
.notice{background:#e6ffef;padding:12px;border-radius:10px;color:#0a5c2b;margin-top:10px}
.small{color:#777;font-size:13px}
</style>
</head>
<body>

<div id="signup" class="page active">
  <div class="container">
    <h1>GOODWEAR</h1><p class="small">Acheter. Vendre. Gagner.</p>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Mot de passe">
    <input id="username" placeholder="Nom de la boutique / utilisateur">
    <input id="phone" placeholder="Numéro de téléphone de la boutique">
    <button onclick="signup()">S'inscrire</button>
    <button onclick="login()">Se connecter</button>
  </div>
</div>

<div id="market" class="page">
  <div class="container">
    <h2>Marketplace</h2><div id="list"></div>
  </div>
  <div class="nav">
    <button onclick="show('market')"><i class="fa fa-shop"></i></button>
    <button onclick="show('add')"><i class="fa fa-plus"></i></button>
    <button onclick="show('cart')"><i class="fa fa-cart-shopping"></i></button>
    <button onclick="show('profile')"><i class="fa fa-user"></i></button>
  </div>
</div>

<div id="add" class="page">
  <div class="container">
    <h2>Publier un article</h2>
    <input id="title" placeholder="Nom du produit">
    <input id="price" type="number" placeholder="Prix réel ($)">
    <input id="colors" placeholder="Couleurs disponibles">
    <textarea id="desc" placeholder="Description"></textarea>
    <input type="file" id="img" accept="image/*">
    <button onclick="publish()">Publier</button>
  </div>
</div>

<div id="cart" class="page">
  <div class="container">
    <h2>Panier</h2><div id="cartList"></div>
    <div class="notice">Envoyez l'argent au numéro de la boutique du vendeur :<br>
      Airtel Money : +243 970 428 667<br>M-Pesa : +243 836 344 645
    </div>
  </div>
</div>

<div id="profile" class="page">
  <div class="container">
    <h2>Profil</h2>
    <div class="badge">Points : <span id="points">0</span></div>
    <input type="number" id="convertPoints" placeholder="Nombre de points à convertir">
    <button onclick="convert()">Convertir mes points</button>
    <h3>Historique de commandes</h3><div id="orders"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDyeyhiWsguJ1_8cypOGWDWlxLGTrqmXOc",
  authDomain: "good-wear-apk-84677.firebaseapp.com",
  projectId: "good-wear-apk-84677",
  storageBucket: "good-wear-apk-84677.firebasestorage.app",
  messagingSenderId: "293506727538",
  appId: "1:293506727538:web:a8a2cc194bca78272d4ceb"
};
const app = initializeApp(firebaseConfig), auth = getAuth(app), db = getFirestore(app);
let currentUser=null, cart=[];

// Pages
function show(p){document.querySelectorAll('.page').forEach(e=>e.classList.remove('active'));document.getElementById(p).classList.add('active');if(p==='market') renderMarket();if(p==='cart') renderCart();if(p==='profile') renderProfile();}

// Signup/Login
async function signup(){
  const email=document.getElementById('email').value;
  const password=document.getElementById('password').value;
  const username=document.getElementById('username').value;
  const phone=document.getElementById('phone').value;
  if(!email||!password||!username||!phone)return alert("Tous les champs sont obligatoires");
  try{
    const userCredential = await createUserWithEmailAndPassword(auth,email,password);
    currentUser=userCredential.user;
    await setDoc(doc(db,"users",currentUser.uid),{email,username,phone,points:0,history:[]});
    alert("Inscription réussie !");show('market');
  }catch(e){alert(e.message);}
}
async function login(){
  const email=document.getElementById('email').value;
  const password=document.getElementById('password').value;
  if(!email||!password)return alert("Email et mot de passe requis");
  try{
    const userCredential = await signInWithEmailAndPassword(auth,email,password);
    currentUser=userCredential.user; alert("Connexion réussie !"); show('market');
  }catch(e){alert(e.message);}
}

// Auth state
onAuthStateChanged(auth,user=>{if(user){currentUser=user;show('market');}});

// Publish product
async function publish(){
  const title=document.getElementById('title').value;
  const price=document.getElementById('price').value;
  const colors=document.getElementById('colors').value;
  const desc=document.getElementById('desc').value;
  const imgFile=document.getElementById('img').files[0];
  if(!title||!price||!imgFile)return alert("Champs requis");
  const reader=new FileReader();
  reader.onload=async ()=>{
    await addDoc(collection(db,"products"),{title,price:+price,colors,desc,img:reader.result,sellerId:currentUser.uid});
    alert("Produit publié !");show('market');};
  reader.readAsDataURL(imgFile);
}

// Render marketplace
async function renderMarket(){
  const list=document.getElementById('list'); list.innerHTML="";
  const querySnapshot=await getDocs(collection(db,"products"));
  querySnapshot.forEach(docSnap=>{
    const p=docSnap.data();
    list.innerHTML+=`<div class='card'><img src='${p.img}'><h3>${p.title}</h3><p>${p.desc}</p><p class='small'>Couleurs : ${p.colors}</p><div class='price'>$${p.price}</div><button onclick='addCart("${docSnap.id}")'>Ajouter au panier</button></div>`;
  });
}

// Cart
async function addCart(productId){
  const docSnap=await getDocs(collection(db,"products"));
  const productData=docSnap.docs.find(d=>d.id===productId)?.data();
  if(productData){cart.push(productData); alert("Produit ajouté au panier"); renderCart();}
}
function renderCart(){
  const div=document.getElementById('cartList'); div.innerHTML="";
  cart.forEach((p,i)=>{div.innerHTML+=`<div class='card'><img src='${p.img}'><h3>${p.title}</h3><div class='price'>$${p.price}</div><button onclick='buy(${i})'>Acheter</button></div>`;});
}
async function buy(i){
  const p=cart[i]; cart.splice(i,1);
  const userDoc=doc(db,"users",currentUser.uid);
  const uSnap=await getDocs(collection(db,"users"));
  const uData=(await getDoc(userDoc)).data();
  const newHistory=[...(uData.history||[]),p]; const newPoints=(uData.points||0)+Math.floor(p.price);
  await updateDoc(userDoc,{history:newHistory,points:newPoints}); alert("Achat effectué"); renderCart(); renderProfile();
}

// Profile
async function renderProfile(){
  const userDoc=doc(db,"users",currentUser.uid); const uSnap=await getDoc(userDoc); const uData=uSnap.data();
  document.getElementById('points').innerText=uData.points||0;
  document.getElementById('orders').innerHTML="";
  (uData.history||[]).forEach(p=>{document.getElementById('orders').innerHTML+=`<div class='card'><h4>${p.title}</h4><p>$${p.price}</p></div>`;});
}
function convert(){alert("Conversion de points non implémentée");}
</script>
</body>
</html>
