<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GOODWEAR Marketplace</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
*{box-sizing:border-box;font-family:Poppins,Arial,sans-serif}
body{margin:0;background:linear-gradient(135deg,#fffaf5,#fff0e6);color:#333;padding-bottom:90px}
h1,h2,h3{color:#ff6600}
.page{display:none}
.active{display:block}
.container{max-width:900px;margin:auto;background:#fff;border-radius:20px;padding:22px;box-shadow:0 10px 30px rgba(255,102,0,.15)}
input,textarea,button{width:100%;padding:13px;margin:10px 0;border-radius:12px;border:2px solid #ffccb3}
button{background:linear-gradient(135deg,#ff6600,#ff8c33);color:#fff;border:none;font-weight:700;cursor:pointer}

/* MODIFICATION : La barre nav est cach√©e par d√©faut */
.nav{position:fixed;bottom:0;left:0;width:100%;background:#fff;display:none;justify-content:space-around;padding:12px 0;box-shadow:0 -5px 15px rgba(0,0,0,0.05)}
.nav button{background:none;color:#ff6600;font-size:22px;width:auto;margin:0}

.card{border:1px solid #ffe0cc;border-radius:18px;padding:15px;margin:16px 0}
.card img{width:100%;height:230px;object-fit:cover;border-radius:14px}
.price{font-size:22px;font-weight:800;color:#ff6600}
</style>
</head>
<body>

<div id="signup" class="page active">
  <div class="container">
    <h1>GOODWEAR</h1>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Mot de passe">
    <input id="username" placeholder="Nom boutique">
    <input id="phone" placeholder="T√©l√©phone">
    <button onclick="signup()">S'inscrire</button>
    <button onclick="login()">Se connecter</button>
  </div>
</div>

<div id="market" class="page">
  <div class="container">
    <h2>Marketplace</h2>
    <div id="list"></div>
  </div>
</div>

<div id="add" class="page">
  <div class="container">
    <h2>Publier</h2>
    <input id="title" placeholder="Produit">
    <input id="price" type="number" placeholder="Prix">
    <textarea id="desc" placeholder="Description"></textarea>
    <input type="file" id="img-input">
    <button onclick="publish()">Publier</button>
  </div>
</div>

<div id="cart-page" class="page">
  <div class="container">
    <h2>Panier</h2>
    <div id="cartList"></div>
  </div>
</div>

<div id="profile" class="page">
  <div class="container">
    <h2>Profil</h2>
    <h3 id="shopNameDisplay">Chargement...</h3>
    <p>Points : <span id="points">0</span> ‚≠ê</p>
    <div id="orders"></div>
  </div>
</div>

<div id="main-nav" class="nav">
    <button onclick="show('market')"><i class="fa fa-shop"></i></button>
    <button onclick="show('add')"><i class="fa fa-plus"></i></button>
    <button onclick="show('cart-page')"><i class="fa fa-cart-shopping"></i></button>
    <button onclick="show('profile')"><i class="fa fa-user"></i></button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, getDoc, doc, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDyeyhiWsguJ1_8cypOGWDWlxLGTrqmXOc",
  authDomain: "good-wear-apk-84677.firebaseapp.com",
  projectId: "good-wear-apk-84677"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let shoppingCart = []; 

// --- GESTION DES PAGES ET DU MENU ---
function show(pageId){
  document.querySelectorAll('.page').forEach(x=>x.classList.remove('active'));
  document.getElementById(pageId).classList.add('active');

  const nav = document.getElementById('main-nav');
  // On affiche le menu seulement si on n'est PAS sur la page d'inscription
  if(pageId === 'signup') {
    nav.style.display = 'none';
  } else {
    nav.style.display = 'flex';
  }

  if(pageId === "market") renderMarket();
  if(pageId === "cart-page") renderCart();
  if(pageId === "profile") renderProfile();
}

// --- AUTHENTIFICATION ---
async function signup(){
  const e = document.getElementById('email').value;
  const p = document.getElementById('password').value;
  const u = document.getElementById('username').value;
  const t = document.getElementById('phone').value;

  if(!e || p.length < 6) return alert("Email valide et 6 caract√®res min pour le mot de passe");

  try {
    const res = await createUserWithEmailAndPassword(auth, e, p);
    currentUser = res.user;
    await setDoc(doc(db, "users", currentUser.uid), {
      username: u, phone: t, points: 0, history: []
    });
    show("market"); // Le menu appara√Ætra ici
  } catch(err) { alert(err.message); }
}

async function login(){
  const e = document.getElementById('email').value;
  const p = document.getElementById('password').value;
  try {
    const res = await signInWithEmailAndPassword(auth, e, p);
    currentUser = res.user;
    show("market");
  } catch(err) { alert("Erreur de connexion"); }
}

onAuthStateChanged(auth, u => { 
  if(u){ 
    currentUser=u; 
    show("market"); 
  } else {
    show("signup");
  }
});

// --- PRODUITS ---
async function publish(){
  const t = document.getElementById('title').value;
  const pr = document.getElementById('price').value;
  const d = document.getElementById('desc').value;
  const file = document.getElementById('img-input').files[0];

  if(!file) return alert("Ajoute une photo !");

  const r = new FileReader();
  r.onload = async () => {
    await addDoc(collection(db, "products"), {
      title: t, price: Number(pr), desc: d, img: r.result, sellerId: currentUser.uid
    });
    alert("Produit en ligne !");
    show("market");
  }
  r.readAsDataURL(file);
}

async function renderMarket(){
  const list = document.getElementById('list');
  list.innerHTML = "Chargement...";
  const snap = await getDocs(collection(db, "products"));
  list.innerHTML = "";
  snap.forEach(d => {
    const p = d.data();
    list.innerHTML += `<div class="card">
      <img src="${p.img}">
      <h3>${p.title}</h3>
      <p>${p.desc}</p>
      <div class="price">${p.price} ‚Ç¨</div>
      <button onclick="addCart('${d.id}')">Ajouter au panier</button>
    </div>`;
  });
}

async function addCart(id){
  const snap = await getDoc(doc(db, "products", id));
  shoppingCart.push(snap.data());
  alert("Dans le panier !");
}

function renderCart(){
  const cl = document.getElementById('cartList');
  cl.innerHTML = shoppingCart.length === 0 ? "Panier vide" : "";
  shoppingCart.forEach((p, i) => {
    cl.innerHTML += `<div class="card"><h3>${p.title}</h3><div class="price">${p.price} ‚Ç¨</div><button onclick="buy(${i})">Acheter</button></div>`;
  });
}

async function buy(i){
  const product = shoppingCart.splice(i, 1)[0];
  const userRef = doc(db, "users", currentUser.uid);
  const snap = await getDoc(userRef);
  await updateDoc(userRef, {
    points: (snap.data().points || 0) + product.price,
    history: arrayUnion(product)
  });
  alert("Achat effectu√© !");
  renderCart();
}

async function renderProfile(){
  const snap = await getDoc(doc(db, "users", currentUser.uid));
  const data = snap.data();
  document.getElementById('points').innerText = data.points || 0;
  document.getElementById('shopNameDisplay').innerText = data.username || "Boutique";
  
  const ord = document.getElementById('orders');
  ord.innerHTML = "<h4>Historique :</h4>";
  (data.history || []).forEach(h => {
    ord.innerHTML += `<p>üì¶ ${h.title} - ${h.price}‚Ç¨</p>`;
  });
}

window.show=show;
window.signup=signup;
window.login=login;
window.publish=publish;
window.addCart=addCart;
window.buy=buy;
</script>
</body>
</html>

