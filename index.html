<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GOODWEAR | POPULARITY & PROFIL</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@600;800&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --p: #FF6600; --s: #FF3366; --bg: #F8F9FA; --w: #FFFFFF; }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); padding-bottom: 90px; }
        .top-bar { padding: 15px; text-align: center; background: var(--w); font-family: 'Outfit'; font-weight: 800; font-size: 22px; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 100; }
        .container { max-width: 500px; margin: 0 auto; padding: 20px; }
        .page { display: none; } .page.active { display: block; }
        .input-field { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 12px; outline: none; background: #fff; }
        .btn-main { background: linear-gradient(45deg, var(--p), var(--s)); color: #fff; border: none; padding: 16px; border-radius: 12px; font-weight: 700; width: 100%; cursor: pointer; }
        .btn-sec { background: #eee; color: #333; border: none; padding: 16px; border-radius: 12px; font-weight: 700; width: 100%; cursor: pointer; margin-top: 10px; }
        .card { background: var(--w); border-radius: 20px; padding: 15px; margin-bottom: 20px; border: 1px solid #eee; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--w); display: flex; justify-content: space-around; padding: 10px 0 25px; border-top: 1px solid #ddd; z-index: 99; }
        .nav-btn { background: none; border: none; color: #666; font-size: 10px; display: flex; flex-direction: column; align-items: center; width: 18%; cursor: pointer; }
        .nav-btn.active { color: var(--p); }
        .shop-badge { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; cursor: pointer; }
        .shop-img { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 2px solid var(--p); }
        .pop-tag { background: #FFD700; color: #000; font-size: 10px; padding: 2px 6px; border-radius: 5px; font-weight: 800; margin-left: auto; }
    </style>
</head>
<body>

<div class="top-bar">GOODWEAR</div>

<div class="container">
    <div id="signup" class="page">
        <h2 style="font-family:'Outfit'">Cr√©er ta boutique</h2>
        <p>Photo de profil de la boutique :</p>
        <input type="file" id="shop-photo-input" accept="image/*" class="input-field">
        <div id="shop-photo-preview"></div>
        <input type="text" id="username" class="input-field" placeholder="Nom de la boutique">
        <input type="email" id="email" class="input-field" placeholder="Email">
        <input type="password" id="password" class="input-field" placeholder="Mot de passe">
        <button class="btn-main" id="btnSignup">OUVRIR MA BOUTIQUE</button>
    </div>

    <div id="market" class="page">
        <div id="list"></div>
    </div>

    <div id="shop-view" class="page">
        <button class="btn-sec" onclick="showPage('market')">‚Üê Retour</button>
        <div id="shop-header" style="text-align:center; padding:20px;"></div>
        <div id="shop-items-list"></div>
    </div>
</div>

<nav class="bottom-nav">
    <button class="nav-btn" onclick="showPage('market')"><i data-lucide="shopping-bag"></i>Market</button>
    <button class="nav-btn" onclick="showPage('add')"><i data-lucide="plus-square"></i>Vendre</button>
    <button class="nav-btn" onclick="showPage('profile')"><i data-lucide="user"></i>Profil</button>
</nav>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc, query, orderBy, where, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDyeyhiWsguJ1_8cypOGWDWlxLGTrqmXOc",
  authDomain: "good-wear-apk-84677.firebaseapp.com",
  projectId: "good-wear-apk-84677",
  storageBucket: "good-wear-apk-84677.firebasestorage.app",
  messagingSenderId: "293506727538",
  appId: "1:293506727538:web:a8a2cc194bca78272d4ceb"
};

const app = initializeApp(firebaseConfig), auth = getAuth(app), db = getFirestore(app);
let currentUser=null, userData=null, shopImgBase64 = "";

// --- COMPRESSION IMAGE PROFIL ---
document.getElementById('shop-photo-input').onchange = (e) => {
    const reader = new FileReader();
    reader.onload = (ev) => {
        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            canvas.width = 200; canvas.height = 200;
            canvas.getContext('2d').drawImage(img, 0, 0, 200, 200);
            shopImgBase64 = canvas.toDataURL('image/jpeg', 0.6);
            document.getElementById('shop-photo-preview').innerHTML = `<img src="${shopImgBase64}" style="width:80px; height:80px; border-radius:50%; margin-bottom:10px;">`;
        };
        img.src = ev.target.result;
    };
    reader.readAsDataURL(e.target.files[0]);
};

// --- ALGORITHME DE POPULARIT√â ---
// On trie par 'views' (articles) et 'popularity' (boutiques)
async function renderMarket() {
    const list = document.getElementById('list'); list.innerHTML = "Chargement...";
    // Note: 'views' est incr√©ment√© √† chaque clic sur l'article
    const snap = await getDocs(query(collection(db, "products"), orderBy("views", "desc")));
    list.innerHTML = "";
    snap.forEach(d => {
        const p = d.data();
        list.innerHTML += `
            <div class="card" onclick="trackView('${d.id}')">
                <div class="shop-badge" onclick="viewShop('${p.sellerId}')">
                    <img src="${p.sellerImg || 'https://via.placeholder.com/50'}" class="shop-img">
                    <span style="font-weight:700; font-size:14px;">${p.sellerName}</span>
                    ${p.views > 50 ? '<span class="pop-tag">TENDANCE</span>' : ''}
                </div>
                <img src="${p.img}" style="width:100%; height:250px; object-fit:cover; border-radius:15px;">
                <h3>${p.title}</h3>
                <b style="color:var(--p); font-size:20px;">${p.price} $</b>
            </div>`;
    });
    lucide.createIcons();
}

// --- VOIR PROFIL BOUTIQUE & BOOSTER POPULARIT√â ---
window.viewShop = async (sid) => {
    showPage('shop-view');
    const sDoc = await getDoc(doc(db, "users", sid));
    const sData = sDoc.data();
    
    // Booster la popularit√© de la boutique √† chaque visite
    await updateDoc(doc(db, "users", sid), { popularity: increment(1) });

    document.getElementById('shop-header').innerHTML = `
        <img src="${sData.photo || 'https://via.placeholder.com/100'}" style="width:100px; height:100px; border-radius:50%; border:3px solid var(--p);">
        <h2>${sData.username}</h2>
        <p style="color:#666;">Score de popularit√© : üî• ${sData.popularity || 0}</p>
    `;
    
    const pSnap = await getDocs(query(collection(db, "products"), where("sellerId", "==", sid)));
    const list = document.getElementById('shop-items-list'); list.innerHTML = "";
    pSnap.forEach(d => {
        const p = d.data();
        list.innerHTML += `<div class="card"><img src="${p.img}" style="width:100%; border-radius:15px;"><h3>${p.title}</h3></div>`;
    });
};

// --- TRACKER LES VUES ARTICLES ---
window.trackView = async (pid) => {
    await updateDoc(doc(db, "products", pid), { views: increment(1) });
};

// --- INSCRIPTION AVEC PHOTO ---
document.getElementById('btnSignup').onclick = async () => {
    const e = document.getElementById('email').value, ps = document.getElementById('password').value, un = document.getElementById('username').value;
    try {
        const uc = await createUserWithEmailAndPassword(auth, e, ps);
        await setDoc(doc(db, "users", uc.user.uid), {
            username: un, 
            photo: shopImgBase64, 
            popularity: 0,
            createdAt: new Date()
        });
        location.reload();
    } catch(err) { alert(err.message); }
};

window.showPage = (id) => {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if(id==='market') renderMarket();
    lucide.createIcons();
};

onAuthStateChanged(auth, user => {
    if(user) { currentUser = user; showPage('market'); }
    else { document.getElementById('signup').classList.add('active'); }
});
</script>
</body>
</html>
