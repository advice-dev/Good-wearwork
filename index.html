<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GOODWEAR Marketplace</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
*{box-sizing:border-box;font-family:Poppins,Arial,sans-serif}
body{margin:0;background:linear-gradient(135deg,#fffaf5,#fff0e6);color:#333;padding-bottom:90px}
h1,h2,h3{color:#ff6600}.page{display:none}.active{display:block}
.container{max-width:900px;margin:auto;background:#fff;border-radius:20px;padding:22px;box-shadow:0 10px 30px rgba(255,102,0,.15);border:1px solid #ffe0cc}
input,textarea,button{width:100%;padding:13px;margin:10px 0;border-radius:12px;border:2px solid #ffccb3;font-size:15px;background:#fff;color:#333}
input::placeholder,textarea::placeholder{color:#999}
button{background:linear-gradient(135deg,#ff6600,#ff8c33);color:#fff;border:none;font-weight:700;box-shadow:0 4px 12px rgba(255,102,0,.3);cursor:pointer}
button:hover{opacity:.9;transform:translateY(-1px)}
.nav{position:fixed;bottom:0;left:0;width:100%;background:#fff;border-top:2px solid #ffccb3;display:flex;justify-content:space-around;padding:12px 0;z-index:1000}
.nav button{background:none;color:#ff6600;font-size:22px;width:auto;box-shadow:none}
.card{border:1px solid #ffe0cc;border-radius:18px;padding:15px;margin:16px 0;background:#fffaf8}
.card img{width:100%;height:230px;object-fit:cover;border-radius:14px}
.price{font-size:22px;font-weight:800;color:#ff6600}
.badge{background:#ff6600;color:#fff;padding:8px 16px;border-radius:30px;display:inline-block;margin-bottom:12px;font-weight:700}
.notice{background:#fff3e6;padding:15px;border:1px solid #ffccb3;border-radius:10px;color:#333;margin-top:10px; font-weight:bold}
.small{color:#777;font-size:13px}
</style>
</head>
<body>

<div id="signup" class="page active">
  <div class="container">
    <h1>GOODWEAR</h1><p class="small">Acheter. Vendre. Gagnez.</p>
    <input type="email" id="email" placeholder="Email de la boutique">
    <input type="password" id="password" placeholder="Mot de passe">
    <input id="username" placeholder="Nom de la boutique">
    <input id="phone" placeholder="NumÃ©ro de tÃ©lÃ©phone (ex: 083...)">
    <button id="btnSignup">S'inscrire</button>
    <button id="btnLogin">Se connecter</button>
  </div>
</div>

<div id="market" class="page">
  <div class="container">
    <h2 id="welcomeShop">Marketplace</h2>
    <div id="list"></div>
  </div>
  <div class="nav">
    <button onclick="window.showPage('market')"><i class="fa fa-shop"></i></button>
    <button onclick="window.showPage('add')"><i class="fa fa-plus"></i></button>
    <button onclick="window.showPage('cart')"><i class="fa fa-cart-shopping"></i></button>
    <button onclick="window.showPage('profile')"><i class="fa fa-user"></i></button>
  </div>
</div>

<div id="add" class="page">
  <div class="container">
    <h2>Publier un article</h2>
    <input id="title" placeholder="Nom du produit">
    <input id="price" type="number" placeholder="Votre prix vendeur ($)">
    <p class="small" id="taxInfo">Prix final client (+20% frais) : 0 $</p>
    <input id="colors" placeholder="Couleurs disponibles">
    <textarea id="desc" placeholder="Description"></textarea>
    <input type="file" id="img" accept="image/*">
    <button id="btnPublish">Publier</button>
  </div>
</div>

<div id="cart" class="page">
  <div class="container">
    <h2>Mon Panier</h2>
    <div id="cartList"></div>
    <div id="paymentInstructions" class="notice" style="display:none;">
      ðŸ“¢ MODE DE PAIEMENT :<br>
      Veuillez envoyer le montant total au :<br>
      Airtel Money : +243 970 428 667<br>
      M-Pesa : +243 836 344 645
    </div>
  </div>
</div>

<div id="profile" class="page">
  <div class="container">
    <h2>Mon Profil</h2>
    <div id="profileDetails" class="small" style="margin-bottom:15px;"></div>
    <div class="badge">Points : <span id="points">0</span></div>
    <input type="number" id="convertPoints" placeholder="Nombre de points Ã  convertir">
    <button onclick="alert('BientÃ´t disponible !')">Convertir mes points</button>
    <h3>Historique de commandes</h3>
    <div id="orders"></div>
    <button onclick="location.reload()" style="background:grey;">Se dÃ©connecter</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, setDoc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDyeyhiWsguJ1_8cypOGWDWlxLGTrqmXOc",
  authDomain: "good-wear-apk-84677.firebaseapp.com",
  projectId: "good-wear-apk-84677",
  storageBucket: "good-wear-apk-84677.firebasestorage.app",
  messagingSenderId: "293506727538",
  appId: "1:293506727538:web:a8a2cc194bca78272d4ceb"
};

const app = initializeApp(firebaseConfig), auth = getAuth(app), db = getFirestore(app);
let currentUser=null, cart=[], userData=null;

// Navigation Globale
window.showPage = (p) => {
  document.querySelectorAll('.page').forEach(e=>e.classList.remove('active'));
  document.getElementById(p).classList.add('active');
  if(p==='market') renderMarket();
  if(p==='cart') renderCart();
  if(p==='profile') renderProfile();
};

// Inscription
async function signup(){
  const email=document.getElementById('email').value, password=document.getElementById('password').value;
  const username=document.getElementById('username').value, phone=document.getElementById('phone').value;
  if(!email||!password||!username||!phone) return alert("Tous les champs sont requis");
  try{
    const userCred = await createUserWithEmailAndPassword(auth,email,password);
    await setDoc(doc(db,"users",userCred.user.uid),{email,username,phone,points:0,history:[]});
    alert("Boutique crÃ©Ã©e !"); window.showPage('market');
  }catch(e){alert(e.message);}
}
document.getElementById('btnSignup').onclick = signup;

// Connexion
async function login(){
  const email=document.getElementById('email').value, password=document.getElementById('password').value;
  try{
    await signInWithEmailAndPassword(auth,email,password);
    alert("Bienvenue !"); window.showPage('market');
  }catch(e){alert("Erreur de connexion");}
}
document.getElementById('btnLogin').onclick = login;

// Auth State
onAuthStateChanged(auth, async user=>{
  if(user){
    currentUser=user;
    const uSnap = await getDoc(doc(db,"users",user.uid));
    userData = uSnap.data();
    document.getElementById('welcomeShop').innerText = "Market : " + userData.username;
    window.showPage('market');
  }
});

// Publish
document.getElementById('price').oninput = (e) => {
  const final = (e.target.value * 1.2).toFixed(2);
  document.getElementById('taxInfo').innerText = `Prix final client (+20% frais) : ${final} $`;
};

async function publish(){
  const title=document.getElementById('title').value, price=document.getElementById('price').value;
  const colors=document.getElementById('colors').value, desc=document.getElementById('desc').value;
  const imgFile=document.getElementById('img').files[0];
  if(!title||!price||!imgFile) return alert("Champs requis");

  const reader=new FileReader();
  reader.onload=async ()=>{
    await addDoc(collection(db,"products"),{
      title, 
      price: +(price * 1.2).toFixed(2), // Prix avec taxe
      sellerPhone: userData.phone,
      sellerId: currentUser.uid,
      colors, desc, img:reader.result
    });
    alert("Produit en ligne !"); window.showPage('market');
  };
  reader.readAsDataURL(imgFile);
}
document.getElementById('btnPublish').onclick = publish;

// Render Market
async function renderMarket(){
  const list=document.getElementById('list'); list.innerHTML="Chargement...";
  const snap=await getDocs(collection(db,"products"));
  list.innerHTML="";
  snap.forEach(docSnap=>{
    const p=docSnap.data();
    const item = document.createElement('div');
    item.className = 'card';
    item.innerHTML = `<img src='${p.img}'><h3>${p.title}</h3><div class='price'>$${p.price}</div>
      <button onclick='window.addToCart("${docSnap.id}")'>ðŸ›’ Ajouter au panier</button>`;
    list.appendChild(item);
  });
}

window.addToCart = async (id) => {
  const snap = await getDocs(collection(db,"products"));
  const p = snap.docs.find(d=>d.id===id).data();
  // SECURITÃ‰ : On vÃ©rifie si c'est notre propre produit
  if(p.sellerId === currentUser.uid){
    alert("âŒ Impossible d'acheter votre propre article !");
  } else {
    cart.push(p); alert("AjoutÃ© au panier !");
  }
};

function renderCart(){
  const div=document.getElementById('cartList'); div.innerHTML=cart.length===0?"Panier vide":"";
  document.getElementById('paymentInstructions').style.display = cart.length > 0 ? "block" : "none";
  cart.forEach((p,i)=>{
    div.innerHTML+=`<div class='card'><h3>${p.title}</h3><div class='price'>$${p.price}</div>
      <button onclick='window.buy(${i})'>Confirmer l'achat</button></div>`;
  });
}

window.buy = async (i) => {
  const p=cart[i];
  const userDoc=doc(db,"users",currentUser.uid);
  const uData = (await getDoc(userDoc)).data();
  const newHistory=[...(uData.history||[]), p];
  const newPoints=(uData.points||0)+Math.floor(p.price);
  await updateDoc(userDoc,{history:newHistory,points:newPoints});
  cart.splice(i,1);
  alert("Commande validÃ©e ! Effectuez le paiement maintenant.");
  window.showPage('profile');
};

async function renderProfile(){
  if(!userData) return;
  document.getElementById('profileDetails').innerHTML = `Boutique : ${userData.username}<br>Email : ${userData.email}<br>Tel : ${userData.phone}`;
  const uSnap = await getDoc(doc(db,"users",currentUser.uid));
  const data = uSnap.data();
  document.getElementById('points').innerText=data.points||0;
  const orders = document.getElementById('orders'); orders.innerHTML="";
  (data.history||[]).forEach(p=>{
    orders.innerHTML+=`<div class='card'><b>${p.title}</b> - $${p.price}</div>`;
  });
}

</script>
</body>
    </html>
    
