<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GOODWEAR | Final Fix</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@600;800&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #FF6600; --secondary: #FF3366; --bg: #F8F9FA; --white: #FFFFFF; }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); padding-bottom: 90px; }
        .top-bar { padding: 15px; text-align: center; background: var(--white); border-bottom: 1px solid #eee; font-family: 'Outfit'; font-weight: 800; font-size: 20px; position: sticky; top: 0; z-index: 100; }
        .container { max-width: 500px; margin: 0 auto; padding: 15px; }
        .page { display: none; }
        .page.active { display: block; }
        .input-field { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 12px; outline: none; }
        .btn-main { background: linear-gradient(45deg, var(--primary), var(--secondary)); color: white; border: none; padding: 14px; border-radius: 12px; font-weight: 700; width: 100%; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px; }
        .btn-save { background: #444; color: white; border: none; padding: 10px; border-radius: 10px; width: 100%; font-weight: 600; cursor: pointer; }
        .card-item { background: white; border-radius: 20px; overflow: hidden; margin-bottom: 20px; border: 1px solid #eee; }
        .card-img { width: 100%; height: 280px; object-fit: cover; }
        #preview-box { width: 100%; height: 200px; border: 2px dashed #ccc; border-radius: 15px; margin-bottom: 15px; display: none; overflow: hidden; }
        #img-preview { width: 100%; height: 100%; object-fit: cover; }
        .order-item { background: white; padding: 12px; border-radius: 15px; margin-bottom: 12px; border-left: 5px solid var(--primary); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; display: none; justify-content: space-around; padding: 10px 0 25px; border-top: 1px solid #eee; z-index: 1000; }
        .nav-btn { background: none; border: none; display: flex; flex-direction: column; align-items: center; color: #666; width: 25%; font-size: 11px; }
        .nav-btn.active { color: var(--primary); }
    </style>
</head>
<body>

<div class="top-bar">GOODWEAR</div>

<div class="container">
    <div id="signup" class="page">
        <input type="text" id="username" class="input-field" placeholder="Nom Boutique">
        <input type="text" id="address" class="input-field" placeholder="Adresse Livraison">
        <input type="email" id="email" class="input-field" placeholder="Email">
        <input type="password" id="password" class="input-field" placeholder="Mot de passe">
        <button class="btn-main" id="btnSignup">CRÃ‰ER COMPTE</button>
        <button class="btn-main" id="btnLogin" style="background:#888;">CONNEXION</button>
    </div>

    <div id="market" class="page">
        <div id="list"></div>
    </div>

    <div id="add" class="page">
        <div id="preview-box"><img id="img-preview"></div>
        <input type="file" id="img-input" accept="image/*" class="input-field">
        <input type="text" id="title" class="input-field" placeholder="Titre">
        <input type="number" id="price" class="input-field" placeholder="Prix ($)">
        <button class="btn-main" id="btnPublish">PUBLIER</button>
    </div>

    <div id="cart" class="page">
        <h3 style="margin-top:0;">ðŸ›’ Panier & Suivi</h3>
        <div id="orderList"></div>
    </div>

    <div id="profile" class="page">
        <div id="profileContent"></div>
    </div>
</div>

<nav class="bottom-nav" id="main-nav">
    <button class="nav-btn" onclick="showPage('market')"><i data-lucide="shopping-bag"></i>Market</button>
    <button class="nav-btn" onclick="showPage('add')"><i data-lucide="plus-square"></i>Vendre</button>
    <button class="nav-btn" onclick="showPage('cart')"><i data-lucide="shopping-cart"></i>Panier</button>
    <button class="nav-btn" onclick="showPage('profile')"><i data-lucide="user"></i>Profil</button>
</nav>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc, query, orderBy, where, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDyeyhiWsguJ1_8cypOGWDWlxLGTrqmXOc",
  authDomain: "good-wear-apk-84677.firebaseapp.com",
  projectId: "good-wear-apk-84677",
  storageBucket: "good-wear-apk-84677.firebasestorage.app",
  messagingSenderId: "293506727538",
  appId: "1:293506727538:web:a8a2cc194bca78272d4ceb"
};

const app = initializeApp(firebaseConfig), auth = getAuth(app), db = getFirestore(app);
let currentUser=null, userData=null;

onAuthStateChanged(auth, async u => {
    if(u) {
        currentUser = u;
        const s = await getDoc(doc(db, "users", u.uid));
        userData = s.data();
        document.getElementById('main-nav').style.display = 'flex';
        showPage('market');
    } else {
        document.getElementById('signup').classList.add('active');
    }
});

window.showPage = (id) => {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if(id === 'market') renderMarket();
    if(id === 'cart') renderOrders();
    if(id === 'profile') renderProfile();
    lucide.createIcons();
};

// --- APERÃ‡U PHOTO ---
document.getElementById('img-input').onchange = (e) => {
    const f = e.target.files[0];
    if(f) {
        const r = new FileReader();
        r.onload = (ev) => {
            document.getElementById('preview-box').style.display = 'block';
            document.getElementById('img-preview').src = ev.target.result;
        };
        r.readAsDataURL(f);
    }
};

// --- PUBLICATION ---
document.getElementById('btnPublish').onclick = async () => {
    const img = document.getElementById('img-preview').src, t = document.getElementById('title').value, p = document.getElementById('price').value;
    if(!img || !t || !p) return alert("Tout remplir !");
    await addDoc(collection(db, "products"), {
        title: t, price: (p*1.2).toFixed(2), img: img,
        sellerId: currentUser.uid, sellerName: userData.username, createdAt: new Date()
    });
    alert("Mis en vente !");
    showPage('market');
};

// --- MARCHÃ‰ (BLOQUE AUTO-ACHAT) ---
async function renderMarket() {
    const list = document.getElementById('list');
    list.innerHTML = "Chargement...";
    const snap = await getDocs(query(collection(db, "products"), orderBy("createdAt", "desc")));
    list.innerHTML = "";
    snap.forEach(d => {
        const p = d.data();
        const isMine = p.sellerId === currentUser.uid;
        list.innerHTML += `
            <div class="card-item">
                <img src="${p.img}" class="card-img">
                <div style="padding:15px;">
                    <h3>${p.title}</h3>
                    <div style="color:var(--primary); font-weight:800; font-size:22px;">${p.price} $</div>
                    ${isMine ? '<div style="background:#eee; padding:10px; border-radius:10px; text-align:center; margin-top:10px;">VOTRE ARTICLE</div>' : 
                    `<div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                        <button class="btn-main" onclick="buyItem('${d.id}','${p.title.replace(/'/g,"")}','${p.price}','${p.sellerId}','${p.img}')">ACHETER</button>
                        <button class="btn-save" onclick="addToCart('${d.id}','${p.title.replace(/'/g,"")}','${p.price}','${p.img}')">ENREGISTRER</button>
                    </div>`}
                </div>
            </div>`;
    });
}

// --- ACHETER (AVEC NUMÃ‰ROS) ---
window.buyItem = async (id, t, pr, sid, img) => {
    const msg = `ðŸ›’ ACHAT : ${t}\nðŸ’° PRIX : ${pr}$\n\nðŸ’³ PAIEMENT :\n- Airtel : 0970428667\n- M-Pesa : +243 836 344 645\n\nConfirmer la commande ?`;
    if(confirm(msg)) {
        await addDoc(collection(db, "orders"), {
            title: t, price: pr, img: img, sellerId: sid, buyerId: currentUser.uid,
            buyerAddress: userData.address, status: "Ã€ LIVRER", date: new Date()
        });
        alert("Notification envoyÃ©e !");
        showPage('cart');
    }
};

// --- PANIER (ENREGISTRER) ---
window.addToCart = async (id, t, pr, img) => {
    await addDoc(collection(db, "cart"), {
        title: t, price: pr, img: img, buyerId: currentUser.uid
    });
    alert("EnregistrÃ© dans le panier !");
};

// --- RENDU PANIER & SUIVI ---
async function renderOrders() {
    const oList = document.getElementById('orderList');
    oList.innerHTML = "Chargement...";
    const qC = query(collection(db, "cart"), where("buyerId", "==", currentUser.uid));
    const qO = query(collection(db, "orders"), where("buyerId", "==", currentUser.uid));
    const [sC, sO] = await Promise.all([getDocs(qC), getDocs(qO)]);
    oList.innerHTML = "";

    // Affichage Panier (EnregistrÃ©s)
    sC.forEach(d => {
        const c = d.data();
        oList.innerHTML += `
            <div class="order-item" style="border-left-color: #444;">
                <div style="display:flex; align-items:center;">
                    <img src="${c.img}" style="width:50px; height:50px; object-fit:cover; border-radius:8px; margin-right:10px;">
                    <div><b>${c.title}</b><br>${c.price}$</div>
                </div>
                <button onclick="deleteFromCart('${d.id}')" style="background:none; border:none; color:red; font-size:11px; margin-top:5px;">Supprimer</button>
            </div>`;
    });

    // Affichage Commandes (Suivi)
    sO.forEach(d => {
        const o = d.data();
        oList.innerHTML += `
            <div class="order-item">
                <b>EN COURS : ${o.title}</b><br>
                Status: <span style="color:var(--primary);">${o.status}</span>
            </div>`;
    });
}

window.deleteFromCart = async (id) => {
    await deleteDoc(doc(db, "cart", id));
    renderOrders();
};

window.showPage = window.showPage;
lucide.createIcons();
</script>
</body>
</html>
